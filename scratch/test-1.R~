library(data.table)
library(rlist)
library(pipeR)
library(httr)
library(jsonlite)
library(xml2)
library(rsdmx)
library(RCurl)

url <- 'https://sdw-wsrest.ecb.europa.eu/service/data/EXR/M.USD.EUR.SP00.A'

doc <- readSDMX(url) 

doc %>>%
str(2)

doc %>>%
as.data.frame %>>%
data.table ->
    data


url <- 'https://sdw-wsrest.ecb.europa.eu/service/data/EXR/'

doc <- readSDMX(url) 

doc %>>%
str(2)

doc %>>%
as.data.frame %>>%
data.table ->
    data

## -------------------------------------------------------------------------- ##
## Get all codelists                                                          ##
## -------------------------------------------------------------------------- ##
url = 'https://sdw-wsrest.ecb.europa.eu/service/codelist?detail=allstubs'

doc <- readSDMX(url) 

doc %>>%
as.data.frame %>>%
data.table ->
    data


doc %>>%
(codelists) %>>%
list.map({
    . %>>%
    ({
        x <- .
        x %>>% slotNames %>>%
        list.map({
            slot(x,.) %>>% unlist
        }) %>>%
        list.filter(!is.null(.)) %>>%
        as.data.frame %>>%
        data.table
    })  
}) %>>%
rbindlist(fill = TRUE) ->
    o

o %>>% (Name)
o %>>% (agencyID) %>>% unique

resource = 'structure'
o[, query := sprintf('https://sdw-wsrest.ecb.europa.eu/service/%s/%s/%s/%s?detail=allstubs',
              resource,
              agencyID,
              id,
              version)]

o$query %>>%
list.map({
    readSDMX(.) %>>%
    as.data.frame
}) ->
    o2

str(o2,1)

url <- 'https://sdw-wsrest.ecb.europa.eu/service/structure/IMF/CL_VALUATION/1.0?detail=allstubs'
doc <- readSDMX(url)

doc %>>% as.data.frame


url <- 'https://sdw-wsrest.ecb.europa.eu/service/datastructure/ECB/all/references=dataflow'
doc <- readSDMX(url)
